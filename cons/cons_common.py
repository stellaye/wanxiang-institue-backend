from datetime import timedelta,datetime
import sxtwl
from consts.ganzhi import Zhi



benmin_cons_list = [
    [
        "室宿",
        "奎宿",
        "胃宿",
        "毕宿",
        "参宿",
        "鬼宿",
        "张宿",
        "角宿",
        "氐宿",
        "心宿",
        "斗宿",
        "虚宿",
    ],
    [
        "壁宿",
        "娄宿",
        "昴宿",
        "觜宿",
        "井宿",
        "柳宿",
        "翼宿",
        "亢宿",
        "房宿",
        "尾宿",
        "女宿",
        "危宿",
    ],
    [
        "奎宿",
        "胃宿",
        "毕宿",
        "参宿",
        "鬼宿",
        "星宿",
        "轸宿",
        "氐宿",
        "心宿",
        "箕宿",
        "虚宿",
        "室宿",
    ],
    [
        "娄宿",
        "昴宿",
        "觜宿",
        "井宿",
        "柳宿",
        "张宿",
        "角宿",
        "房宿",
        "尾宿",
        "斗宿",
        "危宿",
        "壁宿",
    ],
    [
        "胃宿",
        "毕宿",
        "参宿",
        "鬼宿",
        "星宿",
        "翼宿",
        "亢宿",
        "心宿",
        "箕宿",
        "女宿",
        "室宿",
        "奎宿",
    ],
    [
        "昴宿",
        "觜宿",
        "井宿",
        "柳宿",
        "张宿",
        "轸宿",
        "氐宿",
        "尾宿",
        "斗宿",
        "虚宿",
        "壁宿",
        "娄宿",
    ],
    [
        "毕宿",
        "参宿",
        "鬼宿",
        "星宿",
        "翼宿",
        "角宿",
        "房宿",
        "箕宿",
        "女宿",
        "危宿",
        "奎宿",
        "胃宿",
    ],
    [
        "觜宿",
        "井宿",
        "柳宿",
        "张宿",
        "轸宿",
        "亢宿",
        "心宿",
        "斗宿",
        "虚宿",
        "室宿",
        "娄宿",
        "昴宿",
    ],
    [
        "参宿",
        "鬼宿",
        "星宿",
        "翼宿",
        "角宿",
        "氐宿",
        "尾宿",
        "女宿",
        "危宿",
        "壁宿",
        "胃宿",
        "毕宿",
    ],
    [
        "井宿",
        "柳宿",
        "张宿",
        "轸宿",
        "亢宿",
        "房宿",
        "箕宿",
        "虚宿",
        "室宿",
        "奎宿",
        "昴宿",
        "觜宿",
    ],
    [
        "鬼宿",
        "星宿",
        "翼宿",
        "角宿",
        "氐宿",
        "心宿",
        "斗宿",
        "危宿",
        "壁宿",
        "娄宿",
        "毕宿",
        "参宿",
    ],
    [
        "柳宿",
        "张宿",
        "轸宿",
        "亢宿",
        "房宿",
        "尾宿",
        "女宿",
        "室宿",
        "奎宿",
        "胃宿",
        "觜宿",
        "井宿",
    ],
    [
        "星宿",
        "翼宿",
        "角宿",
        "氐宿",
        "心宿",
        "箕宿",
        "虚宿",
        "壁宿",
        "娄宿",
        "昴宿",
        "参宿",
        "鬼宿",
    ],
    [
        "张宿",
        "轸宿",
        "亢宿",
        "房宿",
        "尾宿",
        "斗宿",
        "危宿",
        "奎宿",
        "胃宿",
        "毕宿",
        "井宿",
        "柳宿",
    ],
    [
        "翼宿",
        "角宿",
        "氐宿",
        "心宿",
        "箕宿",
        "女宿",
        "室宿",
        "娄宿",
        "昴宿",
        "觜宿",
        "鬼宿",
        "星宿",
    ],
    [
        "轸宿",
        "亢宿",
        "房宿",
        "尾宿",
        "斗宿",
        "虚宿",
        "壁宿",
        "胃宿",
        "毕宿",
        "参宿",
        "柳宿",
        "张宿",
    ],
    [
        "角宿",
        "氐宿",
        "心宿",
        "箕宿",
        "女宿",
        "危宿",
        "奎宿",
        "昴宿",
        "觜宿",
        "井宿",
        "星宿",
        "翼宿",
    ],
    [
        "亢宿",
        "房宿",
        "尾宿",
        "斗宿",
        "虚宿",
        "室宿",
        "娄宿",
        "毕宿",
        "参宿",
        "鬼宿",
        "张宿",
        "轸宿",
    ],
    [
        "氐宿",
        "心宿",
        "箕宿",
        "女宿",
        "危宿",
        "壁宿",
        "胃宿",
        "觜宿",
        "井宿",
        "柳宿",
        "翼宿",
        "角宿",
    ],
    [
        "房宿",
        "尾宿",
        "斗宿",
        "虚宿",
        "室宿",
        "奎宿",
        "昴宿",
        "参宿",
        "鬼宿",
        "星宿",
        "轸宿",
        "亢宿",
    ],
    [
        "心宿",
        "箕宿",
        "女宿",
        "危宿",
        "壁宿",
        "娄宿",
        "毕宿",
        "井宿",
        "柳宿",
        "张宿",
        "角宿",
        "氐宿",
    ],
    [
        "尾宿",
        "斗宿",
        "虚宿",
        "室宿",
        "奎宿",
        "胃宿",
        "觜宿",
        "鬼宿",
        "星宿",
        "翼宿",
        "亢宿",
        "房宿",
    ],
    [
        "箕宿",
        "女宿",
        "危宿",
        "壁宿",
        "娄宿",
        "昴宿",
        "参宿",
        "柳宿",
        "张宿",
        "轸宿",
        "氐宿",
        "心宿",
    ],
    [
        "斗宿",
        "虚宿",
        "室宿",
        "奎宿",
        "胃宿",
        "毕宿",
        "井宿",
        "星宿",
        "翼宿",
        "角宿",
        "房宿",
        "尾宿",
    ],
    [
        "女宿",
        "危宿",
        "壁宿",
        "娄宿",
        "昴宿",
        "觜宿",
        "鬼宿",
        "张宿",
        "轸宿",
        "亢宿",
        "心宿",
        "箕宿",
    ],
    [
        "虚宿",
        "室宿",
        "奎宿",
        "胃宿",
        "毕宿",
        "参宿",
        "柳宿",
        "翼宿",
        "角宿",
        "氐宿",
        "尾宿",
        "斗宿",
    ],
    [
        "危宿",
        "壁宿",
        "娄宿",
        "昴宿",
        "觜宿",
        "井宿",
        "星宿",
        "轸宿",
        "亢宿",
        "房宿",
        "箕宿",
        "女宿",
    ],
    [
        "室宿",
        "奎宿",
        "胃宿",
        "毕宿",
        "参宿",
        "鬼宿",
        "张宿",
        "角宿",
        "氐宿",
        "心宿",
        "斗宿",
        "虚宿",
    ],
    [
        "壁宿",
        "娄宿",
        "昴宿",
        "觜宿",
        "井宿",
        "柳宿",
        "翼宿",
        "亢宿",
        "房宿",
        "尾宿",
        "女宿",
        "危宿",
    ],
    [
        "奎宿",
        "胃宿",
        "毕宿",
        "参宿",
        "鬼宿",
        "星宿",
        "轸宿",
        "氐宿",
        "心宿",
        "箕宿",
        "虚宿",
        "室宿",
    ],
]


all_cons = [
    "危宿",
    "虚宿",
    "女宿",
    "斗宿",
    "箕宿",
    "尾宿",
    "心宿",
    "房宿",
    "氐宿",
    "亢宿",
    "角宿",
    "轸宿",
    "翼宿",
    "张宿",
    "星宿",
    "柳宿",
    "鬼宿",
    "井宿",
    "参宿",
    "觜宿",
    "毕宿",
    "昴宿",
    "胃宿",
    "娄宿",
    "奎宿",
    "壁宿",
    "室宿",
]


relation_dict = {
    -13: ("远距离危成", "成", "危"),
    -12: ("远距离安坏", "坏", "安"),
    -11: ("远距离友衰", "友", "衰"),
    -10: ("远距离荣亲", "亲", "荣"),
    -9: ("业胎", "胎", "业"),
    -8: ("中距离荣亲", "荣", "亲"),
    -7: ("中距离友衰", "衰", "友"),
    -6: ("中距离安坏", "坏", "安"),
    -5: ("中距离危成", "危", "成"),
    -4: ("近距离危成", "成", "危"),
    -3: ("近距离安坏", "坏", "安"),
    -2: ("近距离友衰", "友", "衰"),
    -1: ("近距离荣亲", "亲", "荣"),
    0: ("命之星", "命", "命"),
    1: ("近距离荣亲", "荣", "亲"),
    2: ("近距离友衰", "衰", "友"),
    3: ("近距离安坏", "安", "坏"),
    4: ("近距离危成", "危", "成"),
    5: ("中距离危成", "成", "危"),
    6: ("中距离安坏", "坏", "安"),
    7: ("中距离友衰", "友", "衰"),
    8: ("中距离荣亲", "亲", "荣"),
    9: ("业胎", "业", "胎"),
    10: ("远距离荣亲", "荣", "亲"),
    11: ("远距离友衰", "衰", "友"),
    12: ("远距离安坏", "安", "坏"),
    13: ("远距离危成", "危", "成"),
}


def calculate_zhiri_constellation(zhi, weekindex):
    if zhi in "申子辰":
        return "虚毕翼箕奎鬼氐"[weekindex] + "宿"
    if zhi in "亥卯未":
        return "昴张尾壁井亢女"[weekindex] + "宿"
    if zhi in "寅午戌":
        return "星心室参角牛胃"[weekindex] + "宿"
    if zhi in "巳酉丑":
        return "房危觜轸斗娄柳"[weekindex] + "宿"


def adjust_to_beijing_time(original_time, timezone_offset):
    # 将原始时间加上时区偏移量（转换为UTC时间），然后再加上8小时转换为北京时间
    adjusted_time = original_time + timedelta(hours=(8 - timezone_offset))
    return adjusted_time


def get_full_cons_info(borntime_str, timezone):
    if isinstance(borntime_str,str):
        date_format = "%Y-%m-%d %H:%M"
        if borntime_str.count(":")== 2:
            date_format = "%Y-%m-%d %H:%M:%S"
        borntime = datetime.strptime(borntime_str, date_format)
    else:
        borntime = borntime_str

    born_time_beijing_time = adjust_to_beijing_time(borntime, timezone)
    if born_time_beijing_time.hour == 23:
        born_time_beijing_time += timedelta(hours=1)
    your_day = sxtwl.fromSolar(
        born_time_beijing_time.year,
        born_time_beijing_time.month,
        born_time_beijing_time.day,
    )
    your_lunar_month = your_day.getLunarMonth()
    your_lunar_day = your_day.getLunarDay()
    your_benmin_cons = benmin_cons_list[your_lunar_day - 1][your_lunar_month - 1]
    your_week_index = your_day.getWeek()
    your_day_dizhi = Zhi[your_day.getDayGZ().dz]
    your_zhiri_cons = calculate_zhiri_constellation(your_day_dizhi, your_week_index)
    return {"benmin_cons": your_benmin_cons, "zhiri_cons": your_zhiri_cons}
